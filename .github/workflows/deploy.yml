name: Deploy cf-mcp-client to Cloud Foundry

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (e.g., v2.7.0). Leave empty to deploy latest.'
        required: false
        type: string

permissions:
  contents: write

env:
  UPSTREAM_REPO: cpage-pivotal/cf-mcp-client

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.check.outputs.new_release }}
      release_tag: ${{ steps.check.outputs.release_tag }}
      jar_name: ${{ steps.check.outputs.jar_name }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for new release
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ inputs.release_tag }}" ]; then
            RELEASE_TAG="${{ inputs.release_tag }}"
          else
            RELEASE_TAG=$(gh api repos/${{ env.UPSTREAM_REPO }}/releases/latest --jq '.tag_name')
          fi

          echo "Target release: $RELEASE_TAG"

          LAST_DEPLOYED=""
          if [ -f .last-deployed-version ]; then
            LAST_DEPLOYED=$(cat .last-deployed-version)
          fi

          echo "Last deployed: ${LAST_DEPLOYED:-none}"

          if [ "$RELEASE_TAG" = "$LAST_DEPLOYED" ] && [ -z "${{ inputs.release_tag }}" ]; then
            echo "Already deployed $RELEASE_TAG â€” skipping."
            echo "new_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "New release detected: $RELEASE_TAG"
            echo "new_release=true" >> "$GITHUB_OUTPUT"
            echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"

            VERSION=${RELEASE_TAG#v}
            APP_VERSION=${VERSION//./-}
            echo "jar_name=cf-mcp-client-${VERSION}.jar" >> "$GITHUB_OUTPUT"
            echo "version=${APP_VERSION}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download release assets
        if: steps.check.outputs.new_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ steps.check.outputs.release_tag }}" \
            --repo ${{ env.UPSTREAM_REPO }} \
            --pattern "${{ steps.check.outputs.jar_name }}" \
            --pattern "manifest.yml" \
            --dir ./artifacts

      - name: Upload artifacts
        if: steps.check.outputs.new_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: ./artifacts/
          retention-days: 1

  deploy-dev:
    needs: check-release
    if: needs.check-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets

      - name: Deploy to Dev
        run: |
          curl -sL "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=v8&source=github" | tar -zx
          ./cf8 api "${{ secrets.CF_API }}"
          ./cf8 auth "${{ secrets.CF_USERNAME }}" "${{ secrets.CF_PASSWORD }}"
          ./cf8 target -o "${{ secrets.CF_ORG }}" -s "${{ secrets.CF_DEV_SPACE }}"
          ./cf8 push "cf-mcp-client-dev-${{ needs.check-release.outputs.version }}" \
            -f manifest.yml \
            -p "${{ needs.check-release.outputs.jar_name }}"

  deploy-prod:
    needs: [check-release, deploy-dev]
    if: needs.check-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets

      - name: Deploy to Prod
        run: |
          curl -sL "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=v8&source=github" | tar -zx
          ./cf8 api "${{ secrets.CF_API }}"
          ./cf8 auth "${{ secrets.CF_USERNAME }}" "${{ secrets.CF_PASSWORD }}"
          ./cf8 target -o "${{ secrets.CF_ORG }}" -s "${{ secrets.CF_PROD_SPACE }}"
          ./cf8 push "cf-mcp-client-prod-${{ needs.check-release.outputs.version }}" \
            -f manifest.yml \
            -p "${{ needs.check-release.outputs.jar_name }}"

      - name: Record deployed version
        run: |
          echo "${{ needs.check-release.outputs.release_tag }}" > .last-deployed-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last-deployed-version
          git diff --cached --quiet || git commit -m "Record deployment of ${{ needs.check-release.outputs.release_tag }}"
          git push
